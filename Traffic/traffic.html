<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LSPD • Traffic Division</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="topbar" style="border-bottom:none; background:transparent; height:56px;">
        <div class="badge">
          <img src="images/TrafficLogo.png" alt="Traffic Division Logo" class="logo-img"/>
          <span class="hide-sm">LSPD - Traffic Division</span>
        </div>
      </div>

      <nav class="nav">
        <a class="item" href="traffic.html">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/>
          </svg>
          <span class="hide-sm">Dashboard</span>
        </a>

        <div class="section-title">Form Generators</div>
        <div class="sub">
          <div class="item toggle" id="forms-link" role="button" tabindex="0"
               onclick="(function(el){var m=document.getElementById('forms-submenu'); if(!m) return; m.classList.toggle('show'); el.classList.toggle('open');})(this)"
               onkeydown="if(event.key==='Enter'||event.key===' '){this.click(); event.preventDefault();}">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/>
            </svg>
            <span class="hide-sm">Collision Forms</span>
            <span class="chev">▾</span>
          </div>

          <div class="submenu" id="forms-submenu">
            <button class="subbtn" type="button" onclick="openForm('oic')">Traffic Collisions (OIC)</button>
            <button class="subbtn" type="button" onclick="openForm('ceic')">City Employee (CEIC)</button>
            <button class="subbtn" type="button" onclick="openForm('fc')">Fatality (FC)</button>
            <button class="subbtn" type="button" onclick="openForm('cic')">Civilian (CIC)</button>
          </div>

          <!-- LEFT NAV: directly under Collision Forms -->
          <div id="navTrafficReport" class="item" role="button" tabindex="0" onclick="openForm('trafficreport')">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
              <!-- Back sheet -->
              <path d="M5 5h8l4 4v9a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5z" opacity=".6"/>
              <!-- Middle sheet -->
              <path d="M4 7h8l4 4v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z" opacity=".8"/>
              <!-- Top sheet with folded corner -->
              <path d="M6 3h9l5 5v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/>
              <path d="M15 3v5h5"/>
              <!-- Text lines -->
              <line x1="8" y1="13" x2="16" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <line x1="8" y1="17" x2="13" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="hide-sm">Traffic Report</span>
          </div>

        <!-- SETTINGS -->
        <div class="section-title">Miscellaneous</div>
        <div class="sub">
        <div id="btn-calendar"
             class="item nav-link"
             role="button"
             aria-label="Open Calendar"
             title="Calendar"
             tabindex="0">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="3" y="4" width="18" height="18" rx="3"
                  stroke="currentColor" stroke-width="1.5"/>
            <path d="M16 2v4M8 2v4M3 10h18"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="8.5" cy="14.5" r="1" fill="currentColor"/>
            <circle cx="12"   cy="14.5" r="1" fill="currentColor"/>
            <circle cx="15.5" cy="14.5" r="1" fill="currentColor"/>
            <circle cx="8.5" cy="18"   r="1" fill="currentColor"/>
            <circle cx="12"   cy="18"   r="1" fill="currentColor"/>
          </svg>
          <span class="hide-sm">Calendar</span>
        </div>
      </div>
        <div class="sub">
          <div class="item" id="settingsBtn" role="button" tabindex="0">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" aria-hidden="true">
              <path d="M19.14 12.94a7.5 7.5 0 0 0 0-1.88l2.17-1.7a.6.6 0 0 0 .14-.77l-2-3.46a.6.6 0 0 0-.73-.28l-2.56 1.03a7.6 7.6 0 0 0-1.7-.99l-.39-2.7A.6.6 0 0 0 13 1h-2a.6.6 0 0 0-.59.49l-.39 2.7c-.6.24-1.17.56-1.7.99L5.77 4.15a.6.6 0 0 0-.73.28l-2 3.46a.6.6 0 0 0 .14.77l2.17 1.7a7.5 7.5 0 0 0 0 1.88l-2.17 1.7a.6.6 0 0 0-.14.77l2 3.46a.6.6 0 0 0 .73.28l2.56-1.03c.53.43 1.1.76 1.7.99l.39 2.7A.6.6 0 0 0 11 23h2a.6.6 0 0 0 .59-.49l.39-2.7c.6-.23 1.17-.56 1.7-.99l2.56 1.03a.6.6 0 0 0 .73-.28l2-3.46a.6.6 0 0 0-.14-.77l-2.17-1.7ZM12 15.2A3.2 3.2 0 1 1 15.2 12 3.2 3.2 0 0 1 12 15.2Z"/>
            </svg>
            <span class="hide-sm">Settings</span>
          </div>
        </div>
        <!-- /SETTINGS -->
      </nav>
    </aside>

    <!-- MAIN -->
    <section class="main">
      <div class="content">
        <div class="grid">
          <!-- HUB -->
          <div class="card hub-card" id="quickHub">
            <div class="head quickhub-header">Quick Hub</div>
            <div class="hub-body">
              <p>Select a form from <b>Collision Forms</b> in the sidebar to get started.</p>
              <ul class="hub-list">
                <li>Officer Involved (OIC)</li>
                <li>City Employee (CEIC)</li>
                <li>Fatality (FC)</li>
                <li>Civilian (CIC)</li>
              </ul>
            </div>
          </div>

          <!-- Upcoming Events (Dashboard) -->
          <div class="card upcoming-dash" id="upcomingDash">
            <div class="head">Upcoming Events</div>
            <div class="up-body">
              <ul id="upcomingDashList" class="up-list"></ul>
              <div id="upcomingDashEmpty" class="empty">No upcoming events.</div>
            </div>
          </div>

          <div class="card activity-log">
            <div class="head">Activity Log</div>
            <div class="meta" id="activityMeta"></div>
            <ul id="activityList" class="log-list"></ul>
            <div id="activityEmpty" class="empty">No activity yet.</div>
            <div class="log-actions">
              <button class="btn" id="shiftToggleBtn">Start Shift</button>
              <button class="btn" id="addMealBtn"    title="Add meal break">+ Code 7</button>
              <button class="btn" id="addTaskBtn"    title="Add general task">+ Task</button>
              <button id="clearActivity" class="btn ghost">Clear Shift</button>
            </div>
          </div>

          <!-- TCR -->
          <div class="tcr-section hidden">
            <div class="card workarea">
              <div class="head">Traffic Collision Reports</div>
              <div class="form-container" id="form-container">Select a form…</div>
            </div>

            <!-- Removed: duplicate Traffic Report button here -->

            <div class="card output">
              <div class="head">Output</div>
              <div class="title-wrap">
                <input id="outTitle" class="title-input" type="text" readonly value="[TCR-OIC-AM-DDMMYY] STREET, AREA">
              </div>
              <textarea class="bbcode" id="bbcode" readonly>[i]Your generated BBCode will appear here.[/i]</textarea>
              <div class="out-actions">
                <button class="copy-btn" id="copyTitle">Copy TCI Title</button>
                <button class="copy-btn" id="copy-bb">Copy TCI Body</button>
              </div>
            </div>
          </div>
          <!-- /TCR -->
        </div>
      </div>
    </section>
  </div>

  <!-- Shift Start/End modal -->
<div class="modal" id="shiftModal" aria-hidden="true" style="display:none">
  <div class="modal__dialog">
    <div class="modal__header">
      <h3 id="shiftModalTitle">Start Shift</h3>
      <button class="modal__close" data-close>&times;</button>
    </div>
    <div class="modal__body">
      <div class="form-row">
        <label>Start Time (local)
          <input type="datetime-local" id="shift_start_time">
        </label>
        <label>Callsign
          <input type="text" id="shift_callsign" placeholder="e.g., 2T31">
        </label>
      </div>

      <div class="form-row">
        <label>Assignment / Focus
          <select id="shift_assignment">
            <option value="">Select assignment…</option>
            <option>Small Group Operation</option>
            <option>Targeted Enforcement</option>
            <option>Training Session</option>
            <option>General Patrol</option>
          </select>
        </label>
        <label>Area (optional)
          <input type="text" id="shift_area" placeholder="e.g., Vinewood">
        </label>
      </div>

      <div class="form-section">
        <div class="form-row">
          <label class="chk">
            <input type="checkbox" id="shift_partnered">
            <span>Partnered?</span>
          </label>
        </div>
        <div class="form-row" id="shift_partner_block" style="display:none;">
          <label>Partner Name
            <input type="text" id="shift_partner_name" placeholder="e.g., J. Smith">
          </label>
          <label>Partner Badge #
            <input type="text" id="shift_partner_badge" placeholder="e.g., 1234">
          </label>
        </div>
      </div>

      <div class="form-row">
        <label class="full">Notes (optional)
          <input type="text" id="shift_notes" placeholder="Any opening/context notes…">
        </label>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn ghost" data-close>Cancel</button>
      <button class="btn" id="shiftConfirmBtn">Start Shift</button>
    </div>
  </div>
</div>

<!-- Meal Break modal -->
<div class="modal" id="mealModal" aria-hidden="true" style="display:none">
  <div class="modal__dialog">
    <div class="modal__header">
      <h3>Add Meal Break</h3>
      <button class="modal__close" data-close>&times;</button>
    </div>
    <div class="modal__body">
      <div class="form-row">
        <label>Time (local)
          <input type="datetime-local" id="meal_time">
        </label>
        <label>Duration (mins)
          <input type="number" id="meal_mins" min="1" step="1" value="30">
        </label>
      </div>
      <div class="form-row">
        <label class="full">Notes (optional)
          <input type="text" id="meal_notes" placeholder="e.g., Code 7 at Mission Row">
        </label>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn ghost" data-close>Cancel</button>
      <button class="btn" id="mealConfirmBtn">Add Meal</button>
    </div>
  </div>
</div>

<!-- General Task modal -->
<div class="modal" id="taskModal" aria-hidden="true">
  <div class="modal__dialog">
    <div class="modal__header">
      <h3>Add Task</h3>
      <button class="modal__close" data-close>&times;</button>
    </div>
    <div class="modal__body">
      <div class="form-row">
        <label>Time (local)
          <input type="datetime-local" id="task_time">
        </label>
        <label>Task Title
          <input type="text" id="task_title" placeholder="e.g., Directed Traffic">
        </label>
      </div>
      <div class="form-row">
        <label class="full">Details (optional)
          <input type="text" id="task_notes" placeholder="e.g., Vespucci Blvd for 15 minutes">
        </label>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn ghost" data-close>Cancel</button>
      <button class="btn" id="taskConfirmBtn">Add Task</button>
    </div>
  </div>
</div>

<!-- Calendar root (hidden by default) -->
<section id="calendar-root" hidden></section>

<!-- Calendar assets (file:// safe) -->
<link rel="stylesheet" href="assets/calendar.css">
<script src="js/calendar.module.js"></script>

<script>
  // Boot the calendar once, after DOM is ready
  window.addEventListener('DOMContentLoaded', () => {
    if (!window.LSPDCalendar) {
      console.error('Calendar library not loaded');
      return;
    }

    window.LSPDCalendar.initCalendar({
      mountId: 'calendar-root',
      openButtonSelector: '#btn-calendar',
      // Hide all three dashboard cards while the calendar is open
      hideSelectors: ['#quickHub', '.activity-log', '#upcomingDash'],
      onExit: () => {}
    });

    // Belt & braces: make sure the nav button always opens the calendar
    const btn = document.getElementById('btn-calendar');
    if (btn) btn.addEventListener('click', () => window.LSPDCalendar.open());
  });
</script>



  <!-- Scripts -->
  <script src="js/activityLog.core.js"></script>
  <script src="js/activityLog.render.js"></script>
  <script src="js/app.js"></script>
  <script src="js/generators.js"></script>
  <script src="js/userSettings.js"></script>

  <script>
    // Build the panel + greeting
    TDUserSettings.init({ quickHubSelector: '#quickHub' });

    // Wire the settings button
    (function () {
      var btn = document.getElementById('settingsBtn');
      if (btn) {
        btn.addEventListener('click', TDUserSettings.open);
        btn.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') { TDUserSettings.open(); e.preventDefault(); }
        });
      }
    })();
  </script>

<script>
  (function () {
    const STORAGE = 'lspd.crm.calendar.events.v1';
    const listEl  = document.getElementById('upcomingDashList');
    const emptyEl = document.getElementById('upcomingDashEmpty');
    if (!listEl || !emptyEl) return;

    const TZ = 'Europe/London';
    const fmtTime = new Intl.DateTimeFormat('en-GB', { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: false });

    function getEvents() {
      try { return JSON.parse(localStorage.getItem(STORAGE) || '[]'); }
      catch { return []; }
    }

    function renderDashboardUpcoming() {
      const all = getEvents();
      const nowISO = new Date().toISOString();

      // Only show events that haven't finished yet (endISO >= now)
      const items = all
        .filter(e => (e.endISO || e.startISO) >= nowISO)
        .sort((a,b) => (a.startISO).localeCompare(b.startISO))
        .slice(0, 5);

      listEl.innerHTML = '';
      if (items.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      items.forEach(e => {
        const dtStart = new Date(e.startISO);
        const dateStr = dtStart.toLocaleString('en-GB', { timeZone: TZ, day: '2-digit', month: 'short', year: 'numeric' });
        const timeStr = e.allDay ? 'All day' : fmtTime.format(dtStart);

        const li = document.createElement('li');
        li.className = 'up-card';

        const left = document.createElement('div');
        left.className = 'up-left';
        const title = document.createElement('div');
        title.className = 'up-title';
        title.textContent = e.title || '(Untitled)';
        const meta = document.createElement('div');
        meta.className = 'up-meta';
        meta.textContent = `${(e.type||'Other').replace(/^\w/, c=>c.toUpperCase())} • ${dateStr} • ${timeStr}`;
        left.append(title, meta);

        const right = document.createElement('div');
        right.className = 'up-right';
        const badge = document.createElement('span');
        badge.className = 'up-badge';
        badge.textContent = (e.type||'Other').replace(/^\w/, c=>c.toUpperCase());
        right.append(badge);

        li.append(left, right);
        listEl.appendChild(li);
      });
    }

    // initial render + updates from other tabs
    window.addEventListener('DOMContentLoaded', renderDashboardUpcoming);
    window.addEventListener('storage', renderDashboardUpcoming);

    // let the calendar module refresh this after add/edit/delete
    window.renderDashboardUpcoming = renderDashboardUpcoming;
  })();
</script>


</body>
</html>
